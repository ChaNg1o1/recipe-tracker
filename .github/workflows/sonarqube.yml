name: SonarQube Analysis

on:
  push:
    branches: [ main, test ]
  pull_request:
    branches: [ main, test ]
    types: [opened, synchronize, reopened]

jobs:
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better analysis
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Run tests with JaCoCo
      continue-on-error: true
      run: mvn clean verify
    
    - name: Generate JaCoCo Reports
      if: always()
      run: mvn jacoco:report
    
    - name: Upload coverage reports to Codecov
      if: always() && env.CODECOV_TOKEN != ''
      uses: codecov/codecov-action@v4
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        slug: ChaNg1o1/recipe-tracker
        verbose: true
    
    - name: Run SonarQube Analysis
      if: always() && env.SONAR_TOKEN != ''
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL || 'https://sonarcloud.io' }}
        SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION || 'chang1o1' }}
      run: mvn sonar:sonar
        -Dsonar.projectKey=ChaNg1o1_recipe-tracker
        -Dsonar.organization=${{ env.SONAR_ORGANIZATION }}
        -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
        -Dsonar.token=${{ secrets.SONAR_TOKEN }}
        -Dsonar.java.source=17
        -Dsonar.java.target=17
        -Dsonar.exclusions=**/target/**,**/*.sql
        -Dsonar.test.exclusions=src/test/**
        -Dsonar.qualitygate.wait=true
        -Dsonar.qualitygate.timeout=300
        -Dsonar.scm.disabled=false
    
    - name: SonarQube Analysis Complete
      if: always() && env.SONAR_TOKEN != ''
      run: |
        echo "âœ… SonarQube analysis completed successfully"
        echo "ðŸ“Š View results at: https://sonarcloud.io/project/overview?id=ChaNg1o1_recipe-tracker"