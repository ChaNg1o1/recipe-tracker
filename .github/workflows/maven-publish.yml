name: Maven Publish to GitHub Packages

on:
  workflow_run:
    workflows: ["JReleaser Release"]
    types: [completed]

concurrency:
  group: release-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  publish:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Create Maven settings.xml
        run: |
          cat > settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${env.GITHUB_ACTOR}</username>
                <password>${env.GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Download release artifacts
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: jreleaser-release.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: release-artifacts
          path: .

      - name: Verify downloaded artifacts
        run: |
          echo "Verifying downloaded artifacts..."
          ls -la target/*.jar || echo "JAR files not in target/"
          ls -la *.jar 2>/dev/null && mv *.jar target/ || true
          ls -la pom.xml
          ls -la target/

      - name: Publish to GitHub Packages
        run: mvn deploy -s settings.xml -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
